<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WebVR App</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>
<canvas id="renderCanvas" style="width:100%; height:100%;"></canvas>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

// Light + ground + table
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0), scene);
const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 10, height: 10}, scene);
const table = BABYLON.MeshBuilder.CreateBox("table", {width: 2, depth: 2, height: 1}, scene);
table.position.y = 0.5;

// Cubes
for (let i = 0; i < 5; i++) {
  const box = BABYLON.MeshBuilder.CreateBox("box" + i, {size: 0.3}, scene);
  box.position.set(Math.random() * 2 - 1, 1.5, Math.random() * 2 - 1);
}

// XR setup
scene.createDefaultXRExperienceAsync({ floorMeshes: [ground] }).then(xr => {
  if (xr.teleportation) xr.teleportation.addFloorMesh(ground);
});

// WebRTC + WebSocket
const ws = new WebSocket("wss://08e6b6740dd4.ngrok-free.app");// replace with ngrok HTTPS WSS URL
let pc = new RTCPeerConnection();

ws.onopen = () => {
  console.log("VR connected to signaling server");
  ws.send(JSON.stringify({ type: "register", role: "vr" }));
};

const stream = canvas.captureStream(30);
stream.getTracks().forEach(track => pc.addTrack(track, stream));

pc.onicecandidate = e => {
  if (e.candidate) ws.send(JSON.stringify({ type: "ice", role: "vr", candidate: e.candidate }));
};

ws.onmessage = async (event) => {
  const data = JSON.parse(event.data);
  console.log("VR received:", data.type);

  if (data.type === "offer") {
    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type: "answer", answer }));
    console.log("VR: sent answer");
  } else if (data.type === "ice") {
    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  } else if (data.type === "annotation") {
    // Render arrow in VR scene
    const arrow = BABYLON.MeshBuilder.CreateCylinder("arrow", {
      diameterTop: 0,
      diameterBottom: 0.1,
      height: 0.5
    }, scene);
    arrow.position = new BABYLON.Vector3(data.x, data.y, data.z);
    arrow.material = new BABYLON.StandardMaterial("mat", scene);
    arrow.material.diffuseColor = new BABYLON.Color3(1, 0, 0);
  }
};

engine.runRenderLoop(() => scene.render());
</script>
</body>
</html>
